# Just a sample in app purchase generated by chatgpt

## model

```dart
import 'package:flutter/foundation.dart';
import 'package:in_app_purchase/in_app_purchase.dart';

class IAPConsumableManager {
  final String productId;
  final InAppPurchase _iap = InAppPurchase.instance;

  bool available = false;
  List<ProductDetails> products = [];

  int totalSharesBought = 0;

  void Function(int totalSharesBought)? onPurchaseConfirmed;
  void Function(String error)? onPurchaseError;

  IAPConsumableManager({
    required this.productId,
    this.onPurchaseConfirmed,
    this.onPurchaseError,
  });

  Future<void> init() async {
    available = await _iap.isAvailable();
    if (!available) {
      debugPrint('Store not available');
      onPurchaseError?.call('Store not available');
      return;
    }

    final response = await _iap.queryProductDetails({productId});
    if (response.notFoundIDs.isNotEmpty) {
      debugPrint('Product not found: $productId');
      onPurchaseError?.call('Product not found');
      return;
    }
    products = response.productDetails;

    _iap.purchaseStream.listen(_handlePurchases);
  }

  Future<void> buy() async {
    if (products.isEmpty) {
      debugPrint('No products available to buy');
      onPurchaseError?.call('No products available');
      return;
    }
    final purchaseParam = PurchaseParam(productDetails: products.first);
    await _iap.buyConsumable(purchaseParam: purchaseParam, autoConsume: false);
  }

  Future<void> _consumePurchase(PurchaseDetails purchase) async {
    await _iap.consumePurchase(purchase);
  }

  void _handlePurchases(List<PurchaseDetails> purchases) {
    for (final purchase in purchases) {
      if (purchase.status == PurchaseStatus.purchased) {
        _confirmPurchase(purchase);
      } else if (purchase.status == PurchaseStatus.error) {
        debugPrint('Purchase error: ${purchase.error}');
        onPurchaseError?.call(purchase.error?.message ?? 'Unknown error');
      }
    }
  }

  Future<void> _confirmPurchase(PurchaseDetails purchase) async {
    totalSharesBought++;
    onPurchaseConfirmed?.call(totalSharesBought);

    await _consumePurchase(purchase);
    await _iap.completePurchase(purchase);
  }
}


```

2. UI

```dart
import 'package:flutter/material.dart';
import 'iap_consumable_manager.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatefulWidget {
  const MyApp({super.key});
  @override
  State<MyApp> createState() => _MyAppState();
}

class _MyAppState extends State<MyApp> {
  late IAPConsumableManager iapManager;

  @override
  void initState() {
    super.initState();

    iapManager = IAPConsumableManager(
      productId: 'share_product_id', // replace with your real product ID
      onPurchaseConfirmed: (totalShares) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('✅ Purchase confirmed! Total shares: $totalShares')),
        );
        setState(() {});
      },
      onPurchaseError: (error) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('❌ Purchase failed: $error')),
        );
      },
    );

    iapManager.init();
  }

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: Scaffold(
        appBar: AppBar(title: const Text('Consumable IAP Example')),
        body: Center(
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  'Total shares bought:',
                  style: Theme.of(context).textTheme.headline6,
                ),
                const SizedBox(height: 8),
                Text(
                  '${iapManager.totalSharesBought}',
                  style: Theme.of(context)
                      .textTheme
                      .headline2
                      ?.copyWith(color: Colors.green[700]),
                ),
                const SizedBox(height: 32),
                ElevatedButton(
                  onPressed: iapManager.buy,
                  child: const Text('Buy Share'),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

```

3. In android/app/src/main/AndroidManifest.xml, inside the <manifest> tag, add:

```xml
   <uses-permission android:name="com.android.vending.BILLING" />
```
